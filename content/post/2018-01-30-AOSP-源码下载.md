---
title: AOSP (Android8.1.0)源码下载
layout: post
comments: true
tags:
  - AOSP
  - Android
url: "post/df3a1293"
date: 2018-01-30 12:44:34
---

现在学习 Android 不像早些年，会写个 App 就能找到饭碗，如今不看看 Framework 源码有种分分钟掉队的感觉。虽然现在有一些比较优秀的站点提供源码阅读，但是毕竟在浏览器里面阅读，还是会遇到很多限制，最好还是自己下载一份。说道下载问题就来了，AOSP 的仓库被墙了，所以直接不能直接下载，或者说直接下载网速会很慢，还好国内有一些镜像服务可以避免这一问题。

<!--more-->

> 之前用 Ubuntu 直接挂个 SS 就能以 2M/s 速度同步源码，但是最近在 Mac 就死活没得办法了。这里我们使用 [清华](https://mirrors.tuna.tsinghua.edu.cn/help/AOSP/) 的源，不过它给的帮助文档似乎并不能直接照搬。



## 准备工作

准备一块 100G 空闲的磁盘作为下载盘（大一点准没错），毕竟直接下载到系统盘还是不太可取的。然后在你喜欢的地方执行下列命令：

```shell
$ mkdir Android && cd Android
$ mkdir android-8.1.0_r1
```

我们这次下载的是 Android8.1.0 的源码，所以目录就命名成这样，你也可以选择你喜欢的名字！



## 下载 repo 工具

整个 AOSP 还是非常巨大的，所以就会把整个项目拆分成许多的版本管理仓库，这么多仓库需要通过工具来进行管理，也就是这里要下载的 repo 工具。执行命令：

```shell
$ cd Android
$ curl https://mirrors.tuna.tsinghua.edu.cn/git/git-repo -o repo
$ chmod a+x repo # 添加可执行权限
```

因为不太喜欢入侵性太强的配置，这里我们就不把 repo 脚本放到系统其它地方了，等会直接通过路径来引用。

下载好 repo 工具后，repo 还是会尝试访问 Google 的站点，我们再进行修改，让它彻底脱离 Google。使用文本编辑器打开 repo，然后将开头的   `REPO_URL`  字段值替换成  `https://mirrors.tuna.tsinghua.edu.cn/git/git-repo/` 。

## 初始化 repo

默认情况下，通过 repo 同步的将会是整个 AOSP 源码，即各种版本的源码都有，我们要的只是 Android 8.1.0 的分支，所以可以通过 `-b` 来指定需要同步的分支（[可选分支](https://source.android.com/setup/build-numbers#source-code-tags-and-builds)）。

确定分之后执行：

```shell
$ cd Android/android-8.1.0_r1
$ ../repo init -u https://aosp.tuna.tsinghua.edu.cn/platform/manifest -b android-8.1.0_r1
```

终端可能会输出警告信息：

```shell
warning: gpg (GnuPG) is not available.
warning: Installing it is strongly encouraged.
```

忽略就好了。



## 开始下载

准备工作差不多了，可以直接开始下载源码了：

```shell
$ cd Android/android-8.1.0_r1
$ ../repo sync
```

然后就是漫长的等待了，可以去干其他的事情了。下载可能会因为某些问题而中断，所以还要时不时瞄一眼，这里可以写个自动重试的脚本 `sync.sh` ：

```shell
#!/bin/bash
time=1
while :
do
    ../repo sync
    if [ $? == 0 ]
    then
        break
    else
        time=`expr $time + 1`
        echo 'sync failed retry!!'
    fi
done
echo 'tried '${time}' times'
```

`$?` 中保存的是上一条名命令的执行结果状态，**0** 表示成功，**not 0** 表示失败，所以直接简单粗暴地开个死循环，每次执行 `../repo sync` 之后判断状态，然后决定是否要重试。不过这并不能完美解决我们的问题，因为有时失败后需要删除一个 `*.lock` 文件，否则还会在相同的地方失败；并且这个脚本一旦开启只有下载成功才会终止，`Ctrl+C` 也不能终止，只能杀死进程。所以还是需要选择一个好时机（我挂了一晚上）开始下载。



## 导入 AS 

源码下载完之后，我们还需要导入 AS 进行阅读，不过直接导入工程好像会导致不能识别一些文件夹，所以还需要生成一个 `android.ipr` 文件（似乎是 IDEA 的某种描述文件）。

> Mac 下会有一个文件系统大小写敏感的问题，我为了避免麻烦事，下面的操作都是在 Ubuntu 16.04 下面进行的。 我在 AOSP 站点上没有找到关于导入 AS 的说明，所以一开始找的各种博客都是直接 make，这导致我们需要编译整个 AOSP ，但是阅读源码并不需要这样，而且编译环境也是很折腾人，差点就放弃了，后来在 [这里](https://wiki.lineageos.org/import-android-studio-howto.html) 找到的出路。

进入到 `android-8.1.0_r1` 文件夹，执行下列命令：

```shell
$ make idegen
$ development/tools/idegen/idegen.sh
```

执行第一条命令会有如下输出：

```shell
============================================
PLATFORM_VERSION_CODENAME=REL
PLATFORM_VERSION=8.1.0
TARGET_PRODUCT=aosp_arm
TARGET_BUILD_VARIANT=eng
TARGET_BUILD_TYPE=release
TARGET_ARCH=arm
TARGET_ARCH_VARIANT=armv7-a
TARGET_CPU_VARIANT=generic
HOST_ARCH=x86_64
HOST_2ND_ARCH=x86
HOST_OS=linux
HOST_OS_EXTRA=Linux-4.13.0-32-generic-x86_64-with-Ubuntu-16.04-xenial
HOST_CROSS_OS=windows
HOST_CROSS_ARCH=x86
HOST_CROSS_2ND_ARCH=x86_64
HOST_BUILD_TYPE=release
BUILD_ID=OPM1.171019.011
OUT_DIR=out
============================================
ninja: no work to do.
[1/2] glob vendor/*/*/Android.bp
ninja: no work to do.
No need to regenerate ninja file
[ 50% 1/2] glob vendor/*/*/Android.bp
ninja: no work to do.

#### build completed successfully (47 seconds) ####
```

> 上面是第二次执行的输出，应该会差不多

执行第二条命令的终端输出是：

```shell
Read excludes: 77ms
Traversed tree: 146534ms
```

执行完之后，会在工程根目录产生 `android.ipr` 和 `android.iml` 文件，然后就可以使用 AS 打开 `android.ipr` 文件来导入工程了，打开这么一个巨型工程真的很花时间。



>如果并不是想看整个 AOSP 的代码，可以在执行这两条命令之前把自己想要排除的目录或者文件添加到 `development/tools/idegen/excluded-paths` 中，比如我就把 packages 文件夹忽略了，更多的信息可以看一下 `development/tools/idegen/README` 文件。
>
>还有可能会遇到 OOM 的问题，解决方案在 [这里](http://www.2net.co.uk/blog/jack-server.html)  



## AS 阅读体验

工程导入后还会遇上一些其他问题，比如导出冒红等，[这篇](http://www.itwendao.com/article/detail/303152.html) 文章中给出了一些解决方案。