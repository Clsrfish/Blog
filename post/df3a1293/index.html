<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8" />

  
  <title>AOSP (Android 9.0.0)源码下载</title>

  
  





  
  <meta name="author" content="Clsrfish" />
  <meta name="description" content="现在学习 Android 不像早些年，会写个 App 就能找到饭碗，如今不看看 Framework 源码有种分分钟掉队的感觉。虽然现在有一些比较优秀的站点提供源码阅读，但是毕竟在浏览器里面阅读，还是会遇到很多限制，最好还是自己下载一份。说道下载问题就来了，AOSP 的仓库被墙了，所以直接不能直接下载，或者说直接下载网速会很慢，还好国内有一些镜像服务可以避免这一问题。
" />

  
  
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@gohugoio" />
    <meta name="twitter:title" content="AOSP (Android 9.0.0)源码下载" />
    <meta name="twitter:description" content="现在学习 Android 不像早些年，会写个 App 就能找到饭碗，如今不看看 Framework 源码有种分分钟掉队的感觉。虽然现在有一些比较优秀的站点提供源码阅读，但是毕竟在浏览器里面阅读，还是会遇到很多限制，最好还是自己下载一份。说道下载问题就来了，AOSP 的仓库被墙了，所以直接不能直接下载，或者说直接下载网速会很慢，还好国内有一些镜像服务可以避免这一问题。
" />
    <meta name="twitter:image" content="https://clsrfish.github.io/img/avatar.jpg" />
  

  
  <meta property="og:type" content="article" />
  <meta property="og:title" content="AOSP (Android 9.0.0)源码下载" />
  <meta property="og:description" content="现在学习 Android 不像早些年，会写个 App 就能找到饭碗，如今不看看 Framework 源码有种分分钟掉队的感觉。虽然现在有一些比较优秀的站点提供源码阅读，但是毕竟在浏览器里面阅读，还是会遇到很多限制，最好还是自己下载一份。说道下载问题就来了，AOSP 的仓库被墙了，所以直接不能直接下载，或者说直接下载网速会很慢，还好国内有一些镜像服务可以避免这一问题。
" />
  <meta property="og:url" content="https://clsrfish.github.io/Blog/post/df3a1293/" />
  <meta property="og:image" content="https://clsrfish.github.io/img/avatar.jpg" />




<meta name="generator" content="Hugo 0.56.0-DEV" />


<link rel="canonical" href="https://clsrfish.github.io/Blog/post/df3a1293/" />
<link rel="alternative" href="https://clsrfish.github.io/Blog/index.xml" title="小站" type="application/atom+xml" />


<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="format-detection" content="telephone=no,email=no,adress=no" />
<meta http-equiv="Cache-Control" content="no-transform" />


<meta name="robots" content="index,follow" />
<meta name="referrer" content="origin-when-cross-origin" />
<meta name="google-site-verification" content="_moDmnnBNVLBN1rzNxyGUGdPHE20YgbmrtzLIbxaWFc" />
<meta name="msvalidate.01" content="22596E34341DD1D17D6022C44647E587" />





<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="小站" />
<meta name="msapplication-tooltip" content="小站" />
<meta name='msapplication-navbutton-color' content="#5fbf5e" />
<meta name="msapplication-TileColor" content="#5fbf5e" />
<meta name="msapplication-TileImage" content="/img/tile-image-windows.png" />
<link rel="icon" href="https://clsrfish.github.io/Blog/img/favicon.ico" />
<link rel="icon" type="image/png" sizes="16x16" href="https://clsrfish.github.io/Blog/img/favicon-16x16.png" />
<link rel="icon" type="image/png" sizes="32x32" href="https://clsrfish.github.io/Blog/img/favicon-32x32.png" />
<link rel="icon" sizes="192x192" href="https://clsrfish.github.io/Blog/img/touch-icon-android.png" />
<link rel="apple-touch-icon" href="https://clsrfish.github.io/Blog/img/touch-icon-apple.png" />
<link rel="mask-icon" href="https://clsrfish.github.io/Blog/img/safari-pinned-tab.svg" color="#5fbf5e" />



<link rel="stylesheet" href="//cdn.bootcss.com/video.js/6.2.8/alt/video-js-cdn.min.css" />

<link rel="stylesheet" href="https://clsrfish.github.io/Blog/css/bundle.css" />


  
  <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <script src="//cdn.bootcss.com/video.js/6.2.8/ie8/videojs-ie8.min.js"></script>
  <![endif]-->

<!--[if lte IE 11]>
    <script src="//cdn.bootcss.com/classlist/1.1.20170427/classList.min.js"></script>
  <![endif]-->


<script src="//cdn.bootcss.com/object-fit-images/3.2.3/ofi.min.js"></script>


<script src="//cdn.bootcss.com/smooth-scroll/12.1.4/js/smooth-scroll.polyfills.min.js"></script>


</head>
  <body>
    
    <div class="suspension">
      <a title="Go to top" class="to-top is-hide"><span class="icon icon-up"></span></a>
      
        
        <a title="Go to comments" class="to-comment" href="#disqus_thread"><span class="icon icon-comment"></span></a>
        
      
    </div>
    
    
  <header class="site-header">
  <img class="avatar" src="https://clsrfish.github.io/Blog/img/avatar.jpg" alt="Avatar">
  
  <h2 class="title">小站</h2>
  
  <p class="subtitle">~ Keep It Simple &amp; Stupid ~</p>
  <button class="menu-toggle" type="button">
    <span class="icon icon-menu"></span>
  </button>
  <nav class="site-menu collapsed">
    <h2 class="offscreen">Main Menu</h2>
    <ul class="menu-list">
      
      
      
      
        <li class="menu-item
            
            
            
              is-active
            ">
            <a href="https://clsrfish.github.io/Blog/">Home</a>
          </li>
      
        <li class="menu-item
            
            
            ">
            <a href="https://clsrfish.github.io/Blog/tags/">Tags</a>
          </li>
      
        <li class="menu-item
            
            
            ">
            <a href="https://clsrfish.github.io/Blog/links/">Links</a>
          </li>
      
        <li class="menu-item
            
            
            ">
            <a href="https://clsrfish.github.io/Blog/about/">About</a>
          </li>
      
    </ul>
  </nav>
  <nav class="social-menu collapsed">
    <h2 class="offscreen">Social Networks</h2>
    <ul class="social-list">

      
      <li class="social-item">
        <a href="mailto:xinliugm@gmail.com" title="Email"><span class="icon icon-email"></span></a>
      </li>

      
      <li class="social-item">
        <a href="//github.com/dashMrl" title="GitHub"><span class="icon icon-github"></span></a>
      </li>

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <li class="social-item">
        <a href="https://clsrfish.github.io/Blog/img/qrcode.png" title="Wechat"><span class="icon icon-wechat"></span></a>
      </li>

      

      

      

      

      <li class="social-item">
        <a href="https://clsrfish.github.io/Blog/index.xml"><span class="icon icon-rss" title="RSS"></span></a>
      </li>

    </ul>
  </nav>
</header>

  <section class="main post-detail">
    <header class="post-header">
      <h1 class="post-title">AOSP (Android 9.0.0)源码下载</h1>
      <p class="post-meta">@Clsrfish · Jan 30, 2018 · 2 min read</p>
    </header>
    <article class="post-content"><p>现在学习 Android 不像早些年，会写个 App 就能找到饭碗，如今不看看 Framework 源码有种分分钟掉队的感觉。虽然现在有一些比较优秀的站点提供源码阅读，但是毕竟在浏览器里面阅读，还是会遇到很多限制，最好还是自己下载一份。说道下载问题就来了，AOSP 的仓库被墙了，所以直接不能直接下载，或者说直接下载网速会很慢，还好国内有一些镜像服务可以避免这一问题。</p>

<blockquote>
<p>之前用 Ubuntu 直接挂个 SS 就能以 2M/s 速度同步源码，但是最近在 Mac 就死活没得办法了。这里我们使用 <a href="https://mirrors.tuna.tsinghua.edu.cn/help/AOSP/">清华</a> 的源，不过它给的帮助文档似乎并不能直接照搬。</p>
</blockquote>

<h2 id="准备工作">准备工作</h2>

<p>准备一块至少 100G 空闲的磁盘作为下载盘（大一点准没错，强烈建议下载到移动硬盘里）。然后 AOSP 编译环境要求 <strong>大小写敏感（Case-Sensitive）</strong> ，所以先格式化：</p>

<p><img src="https://i.loli.net/2018/08/18/5b77070486e19.png" alt="" /></p>

<p>然后在这个磁盘（分区）上执行：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ mkdir AOSP <span style="color:#f92672">&amp;&amp;</span> cd AOSP
$ mkdir android-9.0.0_r1</code></pre></div>
<p>我们这次下载的是 Android 9.0.0 的源码，所以目录就命名成这样，你也可以选择你喜欢的名字！</p>

<h2 id="下载-repo-工具">下载 repo 工具</h2>

<p>整个 AOSP 还是非常巨大的，所以就会把整个项目拆分成许多的版本管理仓库，这么多仓库需要通过工具来进行管理，也就是这里要下载的 repo 工具。执行命令：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cd AOSP
$ curl https://mirrors.tuna.tsinghua.edu.cn/git/git-repo -o repo
$ chmod a+x repo <span style="color:#75715e"># 添加可执行权限</span></code></pre></div>
<p>因为不太喜欢入侵性太强的配置，就不按照官网的配置来弄了，等会直接通过相对路径来引用 <code>repo</code> 。</p>

<p>这个时候 <code>repo</code> 还是从 Google 的站点进行下载，所以还要简单修改一下。使用文本编辑器打开 repo，然后将开头的 <code>REPO_URL</code> 字段值替换成  <code>https://mirrors.tuna.tsinghua.edu.cn/git/git-repo/</code> 。</p>

<h2 id="初始化-repo">初始化 repo</h2>

<p>默认情况下，通过 repo 同步的将会是整个 AOSP 源码，即各种版本的源码都有，这里我们通过 <code>-b</code> 来指定 Android 9.0.0 分支。<a href="https://source.android.com/setup/build-numbers#source-code-tags-and-builds">其他可选分支</a> 。</p>

<p>然后执行：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cd android-9.0.0_r1
$ ../repo init -u https://aosp.tuna.tsinghua.edu.cn/platform/manifest -b android-9.0.0_r1</code></pre></div>
<p>终端可能会输出一两句警告信息，忽略就好了。</p>

<h2 id="开始下载">开始下载</h2>

<p>初始化工作已经完成，可以直接开始下载源码了：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cd android-9.0.0_r1
$ ../repo sync</code></pre></div>
<p>一般来讲，接下来的几小时至一整晚的时间内可以不鸟它了，但是下载可能会因为某些问题而中断，所以还要时不时瞄一眼，所以我们写个重试的脚本 <code>sync.sh</code> ：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>time<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
<span style="color:#66d9ef">while</span> :
<span style="color:#66d9ef">do</span>
    ../repo sync
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $? <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>
    <span style="color:#66d9ef">then</span>
        break
    <span style="color:#66d9ef">else</span>
        time<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>expr $time + <span style="color:#ae81ff">1</span><span style="color:#e6db74">`</span>
        echo <span style="color:#e6db74">&#39;sync failed retry!!&#39;</span>
    <span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">done</span>
echo <span style="color:#e6db74">&#39;tried &#39;</span><span style="color:#e6db74">${</span>time<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39; times&#39;</span></code></pre></div>
<p><code>$?</code> 中保存的是上一条名命令的执行结果状态，<strong>0</strong> 表示成功，<strong>not 0</strong> 表示失败，所以直接简单粗暴地开个死循环，每次执行 <code>../repo sync</code> 之后判断状态，然后决定是否要重试。不过这并不能完美解决我们的问题，因为有时失败后需要删除一个 <code>*.lock</code> 文件，否则还会在相同的地方失败；并且这个脚本一旦开启只有下载成功才会终止，<code>Ctrl+C</code> 也不能终止，只能杀死进程。
如果网络条件不是很好的话，建议挂晚上下载。</p>

<h2 id="导入-as">导入 AS</h2>

<p>源码下载下来后，因为我们只是想阅读源码，所以不用按照官网的上的指引直接执行 <code>make</code> ，那样会导致编译整个工程，等不起。</p>

<p>执行下列命令：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cd android-9.0.0_r1
$ make idegen
$ development/tools/idegen/idegen.sh</code></pre></div>
<p>执行第一条命令会有如下输出：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#f92672">============================================</span>
PLATFORM_VERSION_CODENAME<span style="color:#f92672">=</span>REL
PLATFORM_VERSION<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span>
TARGET_PRODUCT<span style="color:#f92672">=</span>aosp_arm
TARGET_BUILD_VARIANT<span style="color:#f92672">=</span>eng
TARGET_BUILD_TYPE<span style="color:#f92672">=</span>release
TARGET_ARCH<span style="color:#f92672">=</span>arm
TARGET_ARCH_VARIANT<span style="color:#f92672">=</span>armv7-a-neon
TARGET_CPU_VARIANT<span style="color:#f92672">=</span>generic
HOST_ARCH<span style="color:#f92672">=</span>x86_64
HOST_2ND_ARCH<span style="color:#f92672">=</span>x86
HOST_OS<span style="color:#f92672">=</span>darwin
HOST_OS_EXTRA<span style="color:#f92672">=</span>Darwin-18.0.0-x86_64-10.14
HOST_BUILD_TYPE<span style="color:#f92672">=</span>release
BUILD_ID<span style="color:#f92672">=</span>PPR1.180610.009
OUT_DIR<span style="color:#f92672">=</span>out
<span style="color:#f92672">============================================</span>
<span style="color:#f92672">[</span><span style="color:#ae81ff">1</span>/1<span style="color:#f92672">]</span> out/soong/.minibootstrap/minibp out/soong/.bootstrap/build.ninja
<span style="color:#f92672">[</span><span style="color:#ae81ff">55</span>/56<span style="color:#f92672">]</span> glob prebuilts/ndk/stl.bp
<span style="color:#f92672">[</span><span style="color:#ae81ff">77</span>/77<span style="color:#f92672">]</span> out/soong/.bootstrap/bin/soong_build out/soong/build.ninja
out/build-aosp_arm-cleanspec.ninja is missing, regenerating...
out/build-aosp_arm.ninja is missing, regenerating...
<span style="color:#f92672">[</span><span style="color:#ae81ff">2</span>/934<span style="color:#f92672">]</span> including art/Android.mk ...
art/build/Android.common.mk:50: warning: unsupported HOST_ARCH<span style="color:#f92672">=</span>x86_64
<span style="color:#f92672">[</span><span style="color:#ae81ff">564</span>/934<span style="color:#f92672">]</span> including system/sepolicy/Android.mk ...
system/sepolicy/Android.mk:79: warning: BOARD_SEPOLICY_VERS not specified, assuming current platform version
<span style="color:#f92672">[</span><span style="color:#ae81ff">934</span>/934<span style="color:#f92672">]</span> including tools/tradefederation/core/Android.mk ...
art/build/Android.gtest.mk:121: warning: overriding commands <span style="color:#66d9ef">for</span> target <span style="color:#e6db74">`</span>Uncompressed<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">art/build/Android.gtest.mk:101: warning: ignoring old commands for target `Uncompressed&#39;</span>
<span style="color:#f92672">[</span> <span style="color:#ae81ff">99</span>% <span style="color:#ae81ff">919</span>/920<span style="color:#f92672">]</span> glob tools/tradefederation/core/python-lib/tradefed_py/*.py
<span style="color:#f92672">[</span><span style="color:#ae81ff">100</span>% <span style="color:#ae81ff">38</span>/38<span style="color:#f92672">]</span> Install: out/host/darwin-x86/framework/idegen.jar</code></pre></div>
<blockquote>
<p>这里输出了一些配置信息，然后后面做了一些预处理，这里有个新词 <strong>ninja</strong> ，这是一个新的构建工具，关于它和 Makefile 的区别，可以看 <a href="http://note.qidong.name/2017/08/android-ninja/">这里</a> 。</p>
</blockquote>

<p>执行第二条命令会输出：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">Read excludes: 77ms
Traversed tree: 146534ms</code></pre></div>
<p>执行完之后，会在工程根目录产生 <code>android.ipr</code> 、<code>android.iml</code> 文件，然后就可以使用 AS 打开 <code>android.ipr</code> 文件来导入工程了。</p>

<blockquote>
<p>如果并不是想看整个 AOSP 的代码，可以在执行这两条命令之前把自己想要排除的目录或者文件添加到 <code>development/tools/idegen/excluded-paths</code> 中，比如我就把 packages 文件夹忽略了，更多的信息可以看一下 <code>development/tools/idegen/README</code> 文件。
编译环境方面，一般来讲新版本 AOSP 和最新的 Mac/Linux 系统版本都不会出现环境问题，但是在出现新系统编译旧 AOSP 代码就极有可能出现一些环境错误，比如需要安装 JDK6。这个时候莫要慌，如果不介意在电脑上装一些环境可以按照错误来配置，介意的话，可以装个 Ubuntu 虚拟机来编译，或者更轻量的 Docker</p>

<p>如果是 <strong>4.4</strong> 的源码，可以使用我构建好的镜像进行编译: <code>docker run --rm -v /path/to/aosp/source:/android-4.4 dashmrl/aosp-builder-4.4</code></p>
</blockquote>

<h2 id="as-阅读体验">AS 阅读体验</h2>

<blockquote>
<p>AS 首次打开这么一个工程真的非常耗时，主要是在做一些 index 操作，我的 MBP15 花了 20min 才完成，所以没有下定决定看源码之前，就不要打开这个工程了，然后也不要轻易关闭这个工程QAQ&hellip;</p>

<p>还有可能会遇到 OOM 的问题，可以看看 <a href="http://www.2net.co.uk/blog/jack-server.html">这里</a></p>
</blockquote>

<p>工程导入后还会遇上一些其他问题，如果发现 IDE 提示文件行数太大、大小写，可以配置一下 IDE 属性，选择 Help 顶部菜单，然后选择 Edit Custom Properties，然后填入：</p>

<pre><code># 不够就 100000
idea.max.intellisense.filesize=10000
idea.case.sensitive.fs=true
</code></pre>

<p>这时候还有可能会出现点击某个类，但是跳转到类 SDK 代码里，而不是 AOSP 的代码，所以这里在配置一下 SDK。
选择 File-&gt;Project Structure，然后选中 Module：
<img src="https://i.loli.net/2018/08/18/5b77070b4509e.png" alt="" />
选择对应 Module SDK，这里 Android P 就选 28，然后按照图中删除其余的包，保存。</p>

<p>这时候有一些类或方法还是红的不能跳转，大部分原因是因为有 <code>@hide</code> 　注释，不过影响也不大。</p></article>
    <footer class="post-footer">
      
      <ul class="post-tags">
        
          <li><a href="https://clsrfish.github.io/Blog/tags/aosp"><span class="tag">AOSP</span></a></li>
        
          <li><a href="https://clsrfish.github.io/Blog/tags/android"><span class="tag">Android</span></a></li>
        
      </ul>
      
      <p class="post-copyright">
        207-2018 © This post is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License，please give source if you wish to quote or reproduce.This post was published <strong>459</strong> days ago, content in the post may be inaccurate, even wrong now, please take risk yourself.
      </p>
    </footer>
    
      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "disqus_shortname" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
    
  </section>
  <footer class="site-footer">
  <p>© 2017-2019 小站</p>
  <p>Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> with theme <a href="https://github.com/laozhu/hugo-nuo" target="_blank">Nuo</a>.</p>
  
</footer>



<script async src="//cdn.bootcss.com/video.js/6.2.8/alt/video.novtt.min.js"></script>
<script async src="//cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\\[','\\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    }
  });
</script>
<script type="text/x-mathjax-config">
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script>

<script src="https://clsrfish.github.io/Blog/js/bundle.js"></script>




  </body>
</html>
